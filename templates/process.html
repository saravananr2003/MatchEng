{% extends "base.html" %}
{% set active_page = 'process' %}

{% block title %}Process & Match - MatchEng{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Process & Match</h1>
  <p class="muted">Run the matching engine on your uploaded file.</p>
</div>

<div id="status" class="status" hidden></div>

<div class="card">
  <h2>Selected File</h2>
  <div id="fileInfo" class="file-summary">
    <p class="muted">No file selected. <a href="/upload">Upload a file</a> first.</p>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Output Columns</h2>
    <div>
      <button class="btn-secondary btn-small" onclick="selectAllColumns()">Select All</button>
      <button class="btn-secondary btn-small" onclick="deselectAllColumns()">Deselect All</button>
    </div>
  </div>
  <div id="outputColumns" class="columns-selector">
    <div class="loading">Loading columns...</div>
  </div>
</div>

<div class="card">
  <button class="btn-primary btn-large" onclick="runProcess()" id="processBtn">
    ⚡ Start Matching Process
  </button>
</div>

<div id="progressSection" class="card" hidden>
  <h2>Processing</h2>
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <p id="progressText" class="muted">Starting...</p>
</div>

<div id="resultsSection" class="card" hidden>
  <h2>Results</h2>
  <div id="statsContainer"></div>
  <div class="form-actions">
    <a href="/results" class="btn-secondary">View All Results</a>
    <a id="downloadLink" href="#" class="btn-primary" download>Download Results</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let fieldMapping = {};
let selectedColumns = [];

document.addEventListener('DOMContentLoaded', async () => {
  // Check for processed file from analytics first
  const processedFileData = sessionStorage.getItem('currentProcessedFile');
  
  if (processedFileData) {
    const processedFile = JSON.parse(processedFileData);
    currentFile = {
      processed_filename: processedFile.processed_filename,
      analytics_filename: processedFile.analytics_filename,
      source: processedFile.source || 'analytics'
    };
    
    // Load file info from processed file
    try {
      const response = await fetch(`/api/processed-file-preview/${processedFile.processed_filename}`);
      const preview = await response.json();
      
      if (preview.error) {
        throw new Error(preview.error);
      }
      
      document.getElementById('fileInfo').innerHTML = `
        <div class="file-summary-item">
          <strong>File:</strong> ${escapeHtml(processedFile.processed_filename)}
        </div>
        <div class="file-summary-item">
          <strong>Rows:</strong> ${preview.total_rows || 'Unknown'}
        </div>
        <div class="file-summary-item">
          <strong>Columns:</strong> ${(preview.headers || []).length}
        </div>
        <div class="file-summary-item">
          <strong>Source:</strong> Processed file (from Analytics)
        </div>
      `;
    } catch (error) {
      document.getElementById('fileInfo').innerHTML = `
        <p class="muted">Error loading file info: ${escapeHtml(error.message)}</p>
      `;
    }
  } else {
    // Load from session (legacy upload flow)
    const fileData = sessionStorage.getItem('currentFile');
    const mappingData = sessionStorage.getItem('fieldMapping');
    
    if (fileData) {
      currentFile = JSON.parse(fileData);
      document.getElementById('fileInfo').innerHTML = `
        <div class="file-summary-item">
          <strong>File:</strong> ${escapeHtml(currentFile.filename || currentFile.stored_filename)}
        </div>
        <div class="file-summary-item">
          <strong>Rows:</strong> ${currentFile.total_rows || 'Unknown'}
        </div>
        <div class="file-summary-item">
          <strong>Columns:</strong> ${(currentFile.headers || []).length}
        </div>
      `;
    }
    
    if (mappingData) {
      fieldMapping = JSON.parse(mappingData);
    }
  }
  
  await loadOutputColumns();
});

async function loadOutputColumns() {
  try {
    const [columnsResponse, configResponse] = await Promise.all([
      fetch('/api/columns'),
      fetch('/api/column-config')
    ]);
    
    const columnsMetadata = await columnsResponse.json();
    const columnConfig = await configResponse.json();
    
    // Group columns
    const groups = {};
    for (const [col, meta] of Object.entries(columnsMetadata)) {
      const group = meta.group || 'other';
      if (!groups[group]) groups[group] = [];
      groups[group].push({ name: col, ...meta });
    }
    
    // Add matching result columns
    const resultColumns = [
      { name: 'DEDUP_KEY', display_label: 'Dedup Key', group: 'matching-results' },
      { name: 'MATCH_REASON', display_label: 'Match Reason', group: 'matching-results' },
      { name: 'MATCH_TIMESTAMP', display_label: 'Match Timestamp', group: 'matching-results' },
      { name: 'MATCHED_RECORD_IDS', display_label: 'Matched Record IDs', group: 'matching-results' }
    ];
    
    for (const col of resultColumns) {
      if (!groups[col.group]) groups[col.group] = [];
      if (!groups[col.group].find(c => c.name === col.name)) {
        groups[col.group].push(col);
      }
    }
    
    let html = '';
    for (const [group, cols] of Object.entries(groups).sort()) {
      html += `
        <div class="column-group">
          <div class="column-group-header">
            <label>
              <input type="checkbox" onchange="toggleGroup('${group}', this.checked)" checked />
              ${formatGroupName(group)}
            </label>
          </div>
          <div class="column-group-items">
      `;
      
      for (const col of cols.sort((a, b) => a.name.localeCompare(b.name))) {
        const isDefault = col.required || group === 'matching-results';
        html += `
          <label class="column-checkbox">
            <input type="checkbox" 
                   value="${col.name}" 
                   data-group="${group}"
                   ${isDefault ? 'checked' : ''}
                   onchange="updateSelectedColumns()" />
            ${escapeHtml(col.display_label || col.name)}
          </label>
        `;
      }
      
      html += '</div></div>';
    }
    
    document.getElementById('outputColumns').innerHTML = html;
    updateSelectedColumns();
  } catch (error) {
    document.getElementById('outputColumns').innerHTML = '<p class="muted">Failed to load columns.</p>';
  }
}

function formatGroupName(group) {
  return group.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

function toggleGroup(group, checked) {
  document.querySelectorAll(`input[data-group="${group}"]`).forEach(cb => {
    cb.checked = checked;
  });
  updateSelectedColumns();
}

function selectAllColumns() {
  document.querySelectorAll('#outputColumns input[type="checkbox"]').forEach(cb => {
    cb.checked = true;
  });
  updateSelectedColumns();
}

function deselectAllColumns() {
  document.querySelectorAll('#outputColumns input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });
  updateSelectedColumns();
}

function updateSelectedColumns() {
  selectedColumns = [];
  document.querySelectorAll('#outputColumns input[type="checkbox"]:checked').forEach(cb => {
    if (cb.value && cb.value !== 'on') {
      selectedColumns.push(cb.value);
    }
  });
}

async function runProcess() {
  if (!currentFile) {
    showToast('No file selected', 'error');
    return;
  }
  
  const btn = document.getElementById('processBtn');
  btn.disabled = true;
  btn.textContent = 'Processing...';
  
  document.getElementById('progressSection').hidden = false;
  document.getElementById('resultsSection').hidden = true;
  
  try {
    let requestBody;
    
    // Check if this is a processed file from analytics
    if (currentFile.processed_filename) {
      requestBody = {
        processed_filename: currentFile.processed_filename,
        output_columns: selectedColumns
      };
    } else {
      // Legacy upload flow
      requestBody = {
        filename: currentFile.stored_filename || currentFile.filename,
        field_mapping: fieldMapping,
        output_columns: selectedColumns
      };
    }
    
    const response = await fetch('/api/process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });
    
    const data = await response.json();
    
    if (data.ok) {
      showResults(data.stats);
      showToast('Processing complete!', 'success');
    } else {
      setStatus('status', data.error || 'Processing failed', 'error');
      showToast('Processing failed', 'error');
    }
  } catch (error) {
    setStatus('status', 'Processing failed: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = '⚡ Start Matching Process';
    document.getElementById('progressSection').hidden = true;
  }
}

function showResults(stats) {
  document.getElementById('resultsSection').hidden = false;
  
  document.getElementById('statsContainer').innerHTML = `
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value">${stats.total_records || 0}</div>
        <div class="stat-label">Total Records</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${stats.matched_existing || 0}</div>
        <div class="stat-label">Matched Existing</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${stats.new_dedup_keys || 0}</div>
        <div class="stat-label">New Dedup Keys</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${stats.errors || 0}</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>
  `;
  
  if (stats.download_url) {
    document.getElementById('downloadLink').href = stats.download_url;
  }
}
</script>
{% endblock %}

