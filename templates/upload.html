{% extends "base.html" %}
{% set active_page = 'upload' %}

{% block title %}Upload File - MatchEng{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Upload File</h1>
  <p class="muted">Upload a CSV file for deduplication and matching.</p>
</div>

<div id="status" class="status" hidden></div>

<div class="card">
  <h2>Select File</h2>
  <div class="upload-zone" id="uploadZone">
    <div class="upload-icon">üìÅ</div>
    <p>Drag and drop a CSV file here, or click to select</p>
    <input type="file" id="fileInput" accept=".csv" hidden />
    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Select File</button>
  </div>
</div>

<div id="previewSection" class="card" hidden>
  <div class="card-header">
    <h2>File Preview</h2>
    <div>
      <span id="fileInfo" class="muted"></span>
      <button class="btn-secondary" onclick="processAndAnalyze()" id="processBtn">Process & Analyze</button>
      <button class="btn-primary" onclick="proceedToMapping()">Continue to Mapping ‚Üí</button>
    </div>
  </div>
  
  <div class="table-container">
    <table id="previewTable" class="data-table">
      <thead id="previewHead"></thead>
      <tbody id="previewBody"></tbody>
    </table>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Uploaded Files</h2>
    <button class="btn-secondary" onclick="loadFileList()">Refresh</button>
  </div>
  <div id="fileList">
    <div class="loading">Loading files...</div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;

document.addEventListener('DOMContentLoaded', () => {
  loadFileList();
  setupDragDrop();
  
  document.getElementById('fileInput').addEventListener('change', handleFileSelect);
});

function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  
  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });
  
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      uploadFile(files[0]);
    }
  });
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    uploadFile(file);
  }
}

async function uploadFile(file) {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Only CSV files are supported', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  setStatus('status', 'Uploading file...', 'info');
  
  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.ok) {
      currentFile = data;
      showPreview(data);
      loadFileList();
      setStatus('status', `File uploaded: ${data.total_rows} rows`, 'success');
    } else {
      setStatus('status', data.error || 'Upload failed', 'error');
    }
  } catch (error) {
    setStatus('status', 'Upload failed: ' + error.message, 'error');
  }
}

function showPreview(data) {
  document.getElementById('previewSection').hidden = false;
  document.getElementById('fileInfo').textContent = `${data.filename} - ${data.total_rows} rows`;
  
  // Build table header
  const thead = document.getElementById('previewHead');
  thead.innerHTML = '<tr>' + data.headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';
  
  // Build table body
  const tbody = document.getElementById('previewBody');
  tbody.innerHTML = data.preview.map(row => 
    '<tr>' + data.headers.map(h => `<td>${escapeHtml(row[h] || '')}</td>`).join('') + '</tr>'
  ).join('');
}

function proceedToMapping() {
  if (currentFile) {
    sessionStorage.setItem('currentFile', JSON.stringify(currentFile));
    window.location.href = '/map_fields';
  }
}

async function loadFileList() {
  try {
    const response = await fetch('/api/files');
    const files = await response.json();
    
    const container = document.getElementById('fileList');
    
    if (files.length === 0) {
      container.innerHTML = '<p class="muted">No files uploaded yet.</p>';
      return;
    }
    
    container.innerHTML = files.map(f => `
      <div class="file-item">
        <div class="file-info">
          <span class="file-name">${escapeHtml(f.filename)}</span>
          <span class="file-meta">${formatSize(f.size)} ‚Ä¢ ${formatDate(f.modified)}</span>
        </div>
        <div class="file-actions">
          <button class="btn-secondary btn-small" onclick="selectFile('${escapeHtml(f.filename)}')">Select</button>
          <button class="btn-danger btn-small" onclick="deleteFile('${escapeHtml(f.filename)}')">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    document.getElementById('fileList').innerHTML = '<p class="muted">Failed to load files.</p>';
  }
}

async function selectFile(filename) {
  try {
    const response = await fetch(`/api/file-preview/${filename}`);
    const data = await response.json();
    
    if (data.error) {
      showToast(data.error, 'error');
      return;
    }
    
    currentFile = {
      stored_filename: filename,
      filename: filename,
      headers: data.headers,
      preview: data.preview,
      total_rows: data.total_rows || data.preview.length
    };
    
    showPreview(currentFile);
  } catch (error) {
    showToast('Failed to load file', 'error');
  }
}

async function deleteFile(filename) {
  if (!confirm(`Delete ${filename}?`)) return;
  
  try {
    const response = await fetch(`/api/files/${filename}`, { method: 'DELETE' });
    const data = await response.json();
    
    if (data.ok) {
      showToast('File deleted', 'success');
      loadFileList();
    } else {
      showToast(data.error || 'Delete failed', 'error');
    }
  } catch (error) {
    showToast('Delete failed', 'error');
  }
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatDate(isoString) {
  return new Date(isoString).toLocaleString();
}

async function processAndAnalyze() {
  if (!currentFile) {
    showToast('No file selected', 'error');
    return;
  }
  
  const btn = document.getElementById('processBtn');
  btn.disabled = true;
  btn.textContent = 'Processing...';
  
  try {
    const response = await fetch('/api/process-file', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: currentFile.stored_filename || currentFile.filename })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      showToast('File processed successfully!', 'success');
      // Redirect to analytics page
      window.location.href = '/analytics';
    } else {
      showToast(data.error || 'Processing failed', 'error');
      btn.disabled = false;
      btn.textContent = 'Process & Analyze';
    }
  } catch (error) {
    showToast('Processing failed: ' + error.message, 'error');
    btn.disabled = false;
    btn.textContent = 'Process & Analyze';
  }
}
</script>
{% endblock %}

