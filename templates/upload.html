{% extends "base.html" %}
{% set active_page = 'upload' %}

{% block title %}Upload File - MatchEng{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Upload File</h1>
  <p class="muted">Upload a CSV file for deduplication and matching.</p>
</div>

<div id="status" class="status" hidden></div>

<div class="card">
  <h2>Select File</h2>
  <div class="upload-zone" id="uploadZone">
    <div class="upload-icon">üìÅ</div>
    <p>Drag and drop a CSV file here, or click to select</p>
    <input type="file" id="fileInput" accept=".csv" hidden />
    <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Select File</button>
  </div>
</div>

<div id="previewSection" class="card" hidden>
  <div class="card-header">
    <h2>File Preview</h2>
    <div>
      <span id="fileInfo" class="muted"></span>
      <button class="btn-secondary" onclick="processAndAnalyze()" id="processBtn">Process & Analyze</button>
      <button class="btn-primary" onclick="proceedToMapping()">Continue to Mapping ‚Üí</button>
    </div>
  </div>
  
  <div class="preview-controls">
    <div class="control-group">
      <label for="rowLimit">Rows to show:</label>
      <select id="rowLimit" onchange="updatePreview()">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="500">500</option>
      </select>
    </div>
    <div class="control-group">
      <button class="filter-btn" onclick="toggleColumnSelector()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
        Filter Columns
        <span id="columnCount" class="filter-badge"></span>
      </button>
    </div>
  </div>
  
  <div id="columnSelector" class="column-selector" hidden>
    <div class="column-selector-header">
      <strong>Select columns to display:</strong>
      <div>
        <button class="btn-small" onclick="selectAllColumns(true)">All</button>
        <button class="btn-small" onclick="selectAllColumns(false)">None</button>
      </div>
    </div>
    <div id="columnCheckboxes" class="column-checkboxes"></div>
  </div>
  
  <div class="table-container resizable" id="tableContainer">
    <table id="previewTable" class="data-table">
      <thead id="previewHead"></thead>
      <tbody id="previewBody"></tbody>
    </table>
    <div class="resize-handle" id="resizeHandle"></div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2>Uploaded Files</h2>
    <button class="btn-secondary" onclick="loadFileList()">Refresh</button>
  </div>
  <div id="fileList">
    <div class="loading">Loading files...</div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.preview-controls {
  display: flex;
  gap: 2rem;
  padding: 1rem;
  background: var(--bg-secondary, #f5f5f5);
  border-radius: 8px;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.control-group label {
  font-weight: 500;
  color: var(--text-muted);
}

.control-group select {
  padding: 0.4rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--card-bg, #fff);
  color: var(--text);
}

.column-selector {
  background: var(--card-bg, #fff);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.column-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.column-checkboxes {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.5rem;
  max-height: 200px;
  overflow-y: auto;
}

.column-checkboxes label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.column-checkboxes label:hover {
  background: var(--bg-secondary, #f5f5f5);
}

.table-container.resizable {
  position: relative;
  min-height: 200px;
  max-height: 600px;
  overflow: auto;
  resize: vertical;
  border: 1px solid var(--border);
  border-radius: 8px;
}

.resize-handle {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 8px;
  background: linear-gradient(to bottom, transparent, var(--border));
  cursor: ns-resize;
}

.data-table th {
  position: sticky;
  top: 0;
  background: var(--bg-secondary, #f5f5f5);
  z-index: 1;
  resize: horizontal;
  overflow: hidden;
  min-width: 80px;
}

.upload-zone {
  padding: 1.5rem !important;
}

.upload-zone .upload-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.upload-zone p {
  margin: 0.5rem 0;
}

.filter-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
}

.filter-btn:hover {
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
}

.filter-btn svg {
  flex-shrink: 0;
}

.filter-badge {
  background: rgba(255, 255, 255, 0.25);
  padding: 0.15rem 0.5rem;
  border-radius: 10px;
  font-size: 0.75rem;
  font-weight: 600;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let selectedColumns = new Set();

document.addEventListener('DOMContentLoaded', () => {
  loadFileList();
  setupDragDrop();
  setupResizeHandle();
  
  document.getElementById('fileInput').addEventListener('change', handleFileSelect);
  
  // Set up event delegation for column checkboxes (safe from XSS)
  const columnCheckboxes = document.getElementById('columnCheckboxes');
  if (columnCheckboxes) {
    columnCheckboxes.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox' && e.target.dataset.column) {
        toggleColumn(e.target.dataset.column);
      }
    });
  }
  
  // Set up event delegation for file list buttons (safe from XSS)
  const fileList = document.getElementById('fileList');
  if (fileList) {
    fileList.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-select-file') && e.target.dataset.filename) {
        selectFile(e.target.dataset.filename);
      } else if (e.target.classList.contains('btn-delete-file') && e.target.dataset.filename) {
        deleteFile(e.target.dataset.filename);
      }
    });
  }
});

function setupResizeHandle() {
  const container = document.getElementById('tableContainer');
  const handle = document.getElementById('resizeHandle');
  let startY, startHeight;
  
  handle.addEventListener('mousedown', (e) => {
    startY = e.clientY;
    startHeight = container.offsetHeight;
    document.addEventListener('mousemove', resize);
    document.addEventListener('mouseup', stopResize);
    e.preventDefault();
  });
  
  function resize(e) {
    const newHeight = startHeight + (e.clientY - startY);
    container.style.height = Math.max(200, Math.min(800, newHeight)) + 'px';
  }
  
  function stopResize() {
    document.removeEventListener('mousemove', resize);
    document.removeEventListener('mouseup', stopResize);
  }
}

function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  
  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('dragover');
  });
  
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      uploadFile(files[0]);
    }
  });
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    uploadFile(file);
  }
}

async function uploadFile(file) {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Only CSV files are supported', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  setStatus('status', 'Uploading file...', 'info');
  
  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.ok) {
      currentFile = data;
      showPreview(data);
      loadFileList();
      setStatus('status', `File uploaded: ${data.total_rows} rows`, 'success');
    } else {
      setStatus('status', data.error || 'Upload failed', 'error');
    }
  } catch (error) {
    setStatus('status', 'Upload failed: ' + error.message, 'error');
  }
}

function showPreview(data) {
  document.getElementById('previewSection').hidden = false;
  document.getElementById('fileInfo').textContent = `${data.filename} - ${data.total_rows} rows`;
  
  // Initialize selected columns (all by default)
  selectedColumns = new Set(data.headers);
  
  // Build column selector checkboxes
  buildColumnSelector(data.headers);
  
  // Render the table
  renderPreviewTable();
}

function buildColumnSelector(headers) {
  const container = document.getElementById('columnCheckboxes');
  container.innerHTML = headers.map(h => `
    <label>
      <input type="checkbox" value="${escapeHtml(h)}" data-column="${escapeHtml(h)}" checked>
      ${escapeHtml(h)}
    </label>
  `).join('');
  updateColumnCount();
}

function toggleColumnSelector() {
  const selector = document.getElementById('columnSelector');
  selector.hidden = !selector.hidden;
}

function toggleColumn(col) {
  if (selectedColumns.has(col)) {
    selectedColumns.delete(col);
  } else {
    selectedColumns.add(col);
  }
  updateColumnCount();
  renderPreviewTable();
}

function selectAllColumns(selectAll) {
  const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.checked = selectAll;
    if (selectAll) {
      selectedColumns.add(cb.value);
    } else {
      selectedColumns.delete(cb.value);
    }
  });
  updateColumnCount();
  renderPreviewTable();
}

function updateColumnCount() {
  const total = currentFile?.headers?.length || 0;
  document.getElementById('columnCount').textContent = `${selectedColumns.size}/${total}`;
}

function updatePreview() {
  renderPreviewTable();
}

function renderPreviewTable() {
  if (!currentFile) return;
  
  const rowLimit = parseInt(document.getElementById('rowLimit').value);
  const headers = currentFile.headers.filter(h => selectedColumns.has(h));
  const rows = currentFile.preview.slice(0, rowLimit);
  
  // Build table header
  const thead = document.getElementById('previewHead');
  thead.innerHTML = '<tr>' + headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr>';
  
  // Build table body
  const tbody = document.getElementById('previewBody');
  tbody.innerHTML = rows.map(row => 
    '<tr>' + headers.map(h => `<td>${escapeHtml(row[h] || '')}</td>`).join('') + '</tr>'
  ).join('');
}

function proceedToMapping() {
  if (currentFile) {
    sessionStorage.setItem('currentFile', JSON.stringify(currentFile));
    window.location.href = '/map_fields';
  }
}

async function loadFileList() {
  try {
    const response = await fetch('/api/files');
    const files = await response.json();
    
    const container = document.getElementById('fileList');
    
    if (files.length === 0) {
      container.innerHTML = '<p class="muted">No files uploaded yet.</p>';
      return;
    }
    
    container.innerHTML = files.map(f => `
      <div class="file-item">
        <div class="file-info">
          <span class="file-name">${escapeHtml(f.filename)}</span>
          <span class="file-meta">${formatSize(f.size)} ‚Ä¢ ${formatDate(f.modified)}</span>
        </div>
        <div class="file-actions">
          <button class="btn-secondary btn-small btn-select-file" data-filename="${escapeHtml(f.filename)}">Select</button>
          <button class="btn-danger btn-small btn-delete-file" data-filename="${escapeHtml(f.filename)}">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (error) {
    document.getElementById('fileList').innerHTML = '<p class="muted">Failed to load files.</p>';
  }
}

async function selectFile(filename) {
  try {
    const response = await fetch(`/api/file-preview/${filename}`);
    const data = await response.json();
    
    if (data.error) {
      showToast(data.error, 'error');
      return;
    }
    
    currentFile = {
      stored_filename: filename,
      filename: filename,
      headers: data.headers,
      preview: data.preview,
      total_rows: data.total_rows || data.preview.length
    };
    
    showPreview(currentFile);
  } catch (error) {
    showToast('Failed to load file', 'error');
  }
}

async function deleteFile(filename) {
  if (!confirm(`Delete ${filename}?`)) return;
  
  try {
    const response = await fetch(`/api/files/${filename}`, { method: 'DELETE' });
    const data = await response.json();
    
    if (data.ok) {
      showToast('File deleted', 'success');
      loadFileList();
    } else {
      showToast(data.error || 'Delete failed', 'error');
    }
  } catch (error) {
    showToast('Delete failed', 'error');
  }
}

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatDate(isoString) {
  return new Date(isoString).toLocaleString();
}

async function processAndAnalyze() {
  if (!currentFile) {
    showToast('No file selected', 'error');
    return;
  }
  
  const btn = document.getElementById('processBtn');
  btn.disabled = true;
  btn.textContent = 'Processing...';
  
  try {
    const response = await fetch('/api/process-file', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: currentFile.stored_filename || currentFile.filename })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      showToast('File processed successfully!', 'success');
      // Redirect to analytics page
      window.location.href = '/analytics';
    } else {
      showToast(data.error || 'Processing failed', 'error');
      btn.disabled = false;
      btn.textContent = 'Process & Analyze';
    }
  } catch (error) {
    showToast('Processing failed: ' + error.message, 'error');
    btn.disabled = false;
    btn.textContent = 'Process & Analyze';
  }
}
</script>
{% endblock %}

